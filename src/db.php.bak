<?php
/**
 * Code Author: SanjayKS
 * Email ID: sanjaykehebbar@gmail.com
 * ---------------------------------------------
 * Version: 1.2.0
 * Info: This script defines the complete database schema for the application.
 * It is called by the setup wizard to initialize all tables.
 * ---------------------------------------------
 * Changelog:
 * - v1.2.0 (2025-09-29): Updated the schema for machine management.
 * - Added 'Protocol' column to the 'machines' table.
 * - Added 'ssh_key' column to 'user_machine_permissions' to store
 * user-specific keys for machine access.
 * - v1.1.0: Added 'is_active' column to users and created 'activity_logs' table.
 * - v1.0.0: Initial schema creation.
 */

function get_db_connection() {
    $db_path = __DIR__ . '/../db/cloudterminal.db';
    if (!is_dir(dirname($db_path))) {
        mkdir(dirname($db_path), 0755, true);
    }
    try {
        $pdo = new PDO('sqlite:' . $db_path);
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        return $pdo;
    } catch (PDOException $e) {
        throw new Exception("Database connection failed.");
    }
}

function initialize_database() {
    $db = get_db_connection();
    
    // Users table
    $users_table_sql = "
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        Fname TEXT NOT NULL, LName TEXT NOT NULL,
        Username TEXT UNIQUE NOT NULL, EmailID TEXT UNIQUE NOT NULL,
        Password TEXT NOT NULL,
        UserType TEXT CHECK(UserType IN ('Admin', 'Faculty', 'Learner')) DEFAULT NULL,
        is_active INTEGER NOT NULL DEFAULT 1
    );";

    // Machines table with new Protocol column
    $machines_table_sql = "
    CREATE TABLE IF NOT EXISTS machines (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        MachineName TEXT NOT NULL,
        IPAddress TEXT NOT NULL,
        Protocol TEXT NOT NULL CHECK(Protocol IN ('SSH', 'RDP'))
    );";

    // Permissions table with new ssh_key column
    $permissions_table_sql = "
    CREATE TABLE IF NOT EXISTS user_machine_permissions (
        user_id INTEGER NOT NULL,
        machine_id INTEGER NOT NULL,
        ssh_key TEXT DEFAULT NULL,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (machine_id) REFERENCES machines(id) ON DELETE CASCADE,
        PRIMARY KEY (user_id, machine_id)
    );";
    
    // Activity Logs table
    $logs_table_sql = "
    CREATE TABLE IF NOT EXISTS activity_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
        actor_id INTEGER, action TEXT NOT NULL,
        target_id INTEGER, details TEXT,
        FOREIGN KEY (actor_id) REFERENCES users(id) ON DELETE SET NULL
    );";

    // Execute all table creation statements
    $db->exec($users_table_sql);
    $db->exec($machines_table_sql);
    $db->exec($permissions_table_sql);
    $db->exec($logs_table_sql);
}
?>